<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WhatsApp Embedded Signup Test</title>
</head>

<body
  style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; font-family: sans-serif;">

  <h1>Onboard Client (Test)</h1>
  <p>Click below to launch the Facebook Login flow.</p>

  <!-- Launch button  -->
  <button onclick="launchWhatsAppSignup()"
    style="background-color: #1877f2; border: 0; border-radius: 4px; color: #fff; cursor: pointer; font-family: Helvetica, Arial, sans-serif; font-size: 16px; font-weight: bold; height: 40px; padding: 0 24px;">Login
    with Facebook</button>

  <div id="status" style="margin-top: 20px; color: #555;"></div>

  <!-- Debug Buttons -->
  <div style="margin-top: 10px;">
    <button onclick="checkStatus()" style="padding: 5px 10px;">Check SDK Status</button>
    <button onclick="logout()" style="padding: 5px 10px;">Force Logout</button>
  </div>

  <div id="logs"
    style="margin-top: 20px; text-align: left; background: #f0f0f0; padding: 10px; border-radius: 4px; width: 80%; max-height: 200px; overflow-y: auto; font-family: monospace;">
  </div>

  <!-- SDK loading -->
  <script async defer src="https://connect.facebook.net/en_US/sdk.js"></script>

  <script>
    // Global Error Handler
    window.onerror = function (msg, url, line) {
      logToScreen(`GLOBAL ERROR: ${msg} (Line ${line})`);
      return false;
    };

    function logToScreen(msg) {
      const logDiv = document.getElementById('logs');
      const p = document.createElement('div');
      p.innerText = `> ${msg}`;
      logDiv.appendChild(p);
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(msg);
    }

    let sessionInfo = {};

    const checkStatus = () => {
      logToScreen("Checking Login Status...");
      FB.getLoginStatus(function (response) {
        logToScreen(`Status: ${response.status}`);
        console.log(response);
      });
    };

    const logout = () => {
      FB.logout(function (response) {
        logToScreen("Logged out.");
      });
    };

    // SDK initialization
    window.fbAsyncInit = function () {
      const appId = '1525473998893477';
      logToScreen(`Initializing Facebook SDK with App ID: ${appId}`);
      FB.init({
        appId: appId, // user app ID
        autoLogAppEvents: true,
        xfbml: true,
        version: 'v24.0'
      });
      logToScreen("SDK Initialized.");
    };

    // Session logging message event listener
    window.addEventListener('message', (event) => {
      if (!event.origin.endsWith('facebook.com')) return;
      try {
        const data = JSON.parse(event.data);
        if (data.type === 'WA_EMBEDDED_SIGNUP') {
          logToScreen(`Event Received: ${data.event}`);

          // Capture the IDs from the event
          if (data.event === 'FINISH') {
            const { waba_id, phone_number_id } = data.data;
            sessionInfo.wabaId = waba_id;
            sessionInfo.phoneNumberId = phone_number_id;
            document.getElementById('status').innerText = `Captured WABA: ${waba_id}, Phone: ${phone_number_id}. Waiting for code...`;
            logToScreen("Captured WABA and Phone ID.");
          }
        }
      } catch {
        // ignore non-JSON messages
      }
    });

    // Response callback
    const fbLoginCallback = (response) => {
      logToScreen("Callback received from Facebook.");

      // Wrap async logic in an IIFE (Immediately Invoked Function Expression)
      (async () => {
        if (response.authResponse) {
          const code = response.authResponse.code;
          logToScreen(`Code received: ${code.substring(0, 10)}...`);

          if (!sessionInfo.wabaId) {
            document.getElementById('status').innerText = "Error: Did not capture WABA ID from flow events. Check console.";
            logToScreen("ERROR: WABA ID missing.");
            return;
          }

          document.getElementById('status').innerText = "Code received. Sending to backend...";

          // SEND TO BACKEND
          try {
            const res = await fetch('https://localhost:3000/api/onboarding/complete', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                code: code,
                wabaId: sessionInfo.wabaId,
                phoneNumberId: sessionInfo.phoneNumberId,
                pin: '123456' // Default test PIN
              })
            });

            const result = await res.json();
            logToScreen(`Backend Result: ${result.success}`);

            if (result.success) {
              document.getElementById('status').innerText = "SUCCESS! Client Onboarded. Check Backend Terminal.";
              document.body.style.backgroundColor = "#d4edda";
            } else {
              document.getElementById('status').innerText = "FAILED: " + result.message;
              document.body.style.backgroundColor = "#f8d7da";
            }

          } catch (err) {
            console.error(err);
            logToScreen("Network Error calling backend.");
            document.getElementById('status').innerText = "Network Error calling backend.";
          }

        } else {
          logToScreen("User cancelled or failed login.");
          document.getElementById('status').innerText = "User cancelled or failed login.";
        }
      })();
    }

    // Launch method and callback registration
    const launchWhatsAppSignup = () => {
      logToScreen("Button Clicked. Launching FB.login...");

      // Popup Blocker Check
      setTimeout(() => {
        logToScreen("... If no popup appeared, CHECK YOUR BROWSER ADDRESS BAR for a 'Popup Blocked' icon!");
      }, 3000);

      FB.login(fbLoginCallback, {
        config_id: '686857787698143', // user config ID
        response_type: 'code',
        override_default_response_type: true,
        extras: {
          setup: {},
        }
      });
    }
  </script>
</body>

</html>